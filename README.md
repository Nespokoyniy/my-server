# my-server (Начальный план по созданию)

**Глобальная цель:** Создать самодостаточную, безопасную и автоматизированную платформу для развертывания и управления веб-приложением, демонстрирующую полный цикл DevOps.

---

### **Фаза 0: Подготовка и Конфигурация (Foundation)**
*(То, что должно быть заложено в основу с самого начала)*

**Цель:** Обеспечить безопасное и гибкое управление настройками на всех этапах.
**Задачи:**
1.  **[ ]** Ввести централизованное управление конфигурацией через **environment variables**.
    *   Создать `.env` файлы для разработки (`backend/.env.dev`) и пример для продакшена (`.env.example`).
2.  **[ ]** Настроить **логирование** в приложении (`app/utils/logger.py`).
    *   Использовать модуль `logging` Python.
    *   Настроить разные уровни логирования (INFO, ERROR, DEBUG).
    *   Ensure logs are formatted in JSON for production (for easier parsing with tools like Loki).

---

### **Фаза 1: Разработка Ядра Приложения (Core Application)**
*(Ваш текущий прогресс здесь отличный!)*

**Цель:** Реализовать полностью работое, протестированное и безопасное веб-приложение.
**Задачи:**
1.  **[~]** **База данных и миграции.** Модели и миграции готовы. Остается поддерживать их актуальность.
2.  **[~]** **Backend API.** Большая часть эндпоинтов готова.
    *   **[ ]** **Добавить Refresh Tokens** для увеличения безопасности.
    *   **[ ]** Реализовать **эндпоинт `/health`** для проверки статуса приложения (здоровье БД, кеша и т.д.). Критично для следующих фаз.
    *   **[ ]** Реализовать **эндпоинты для административного API** (напр., `/admin/restart`, `/admin/logs`), защищенные дополнительным уровнем аутентификации. Это безопасная альтернатива SSH для Telegram-бота.
3.  **[~]** **Frontend (SSR с HTMX).** Базовая структура готова.
    *   **[ ]** Довести до ума все HTML-шаблоны, обеспечить полную функциональность.
    *   **[ ]** Допилить CSS для адаптивности и красивого UI.
4.  **[~]** **Тестирование.**
    *   **[ ]** Написать **интеграционные тесты**, которые проверяют работу с базой данных и аутентификацию.
    *   **[ ]** Написать **тесты для фронтенда** (используя `pytest` с `httpx` для проверки рендеринга страниц и статус-кодов).

---

### **Фаза 2: Контейнеризация и Базовая Оркестрация (Packaging)**
**Цель:** Упаковать приложение в Docker для переносимости и подготовить его к работе в продакшене.
**Задачи:**
1.  **[ ]** **Оптимизировать Dockerfile:**
    *   Использовать многостадийную сборку (multi-stage build) для уменьшения итогового образа.
    *   Добавить `healthcheck` в `Dockerfile` или `docker-compose.yml`, который использует эндпоинт `/health`.
2.  **[ ]** **Доработать docker-compose:**
    *   Создать окончательные версии `docker-compose.dev.yml` и `docker-compose.prod.yml`.
    *   Добавить политику перезапуска: `restart: unless-stopped`.
    *   Реализовать **скрипт инициализации** (например, `start.sh`), который запускает `alembic upgrade head` перед запуском `uvicorn`.
3.  **[ ]** **Настроить Nginx:**
    *   Создать конфиг `nginx/nginx.conf`.
    *   Настроить раздачу статики из `/frontend/static`.
    *   Настроить `proxy_pass` на бэкенд.
    *   Реализовать простую **балансировку нагрузки** между несколькими инстансами бэкенда (например, 2-3 контейнера `backend`).

---

### **Фаза 3: Безопасный Деплоймент и CI/CD (Deployment & Automation)**
**Цель:** Обеспечить безопасный доступ к приложению из интернета и автоматизировать процесс развертывания.
**Задачи:**
1.  **[ ]** **Организовать доступ из интернета:**
    *   **Приоритет 1:** Настроить **WireGuard** на локальной машине и арендовать дешевый **VPS**. Настроить проброс портов с VPS на локальную машину через WireGuard Tunnel.
    *   **Приоритет 2 (Fallback):** Использовать **Cloudflare Tunnel**. Создать бот-приложение в Cloudflare, скачать бинарник и настроить его в Docker-контейнере.
2.  **[ ]** **Настроить HTTPS:**
    *   На VPS настроить Nginx + Certbot для получения сертификатов **Let's Encrypt**.
    *   Либо поручить это Cloudflare Tunnel (он предоставляет свой SSL-сертификат).
3.  **[ ]** **Настроить CI/CD (GitHub Actions):**
    *   Создать workflow-файл (`.github/workflows/deploy.yml`).
    *   **На этапе `test`:** Запускать `pytest` внутри контейнера, используя `Dockerfile.tests`.
    *   **На этапе `deploy`:** Через SSH подключиться к серверу (VPS), выполнить `git pull`, пересобрать контейнеры через `docker-compose -f docker-compose.prod.yml up -d --build`.

---

### **Фаза 4: Инструменты Управления и Мониторинга (Monitoring & Operations)**
**Цель:** Реализовать системы для резервного копирования, безопасности и удобного управления.
**Задачи:**
1.  **[ ]** **Система бэкапов (`/backup`):**
    *   Создать скрипт `backup.sh` / `backup.py`.
    *   Логика: `pg_dump` -> архивация -> шифрование с помощью `gpg` -> загрузка в облако (Yandex Disk, S3) через `rclone` -> отправка отчета в Telegram бота.
    *   Настроить `cron` для ежедневного запуска.
2.  **[ ]** **Сканер уязвимостей (`/vuln-scanner`):**
    *   Создать скрипт `vuln_scan.py`.
    *   Логика: Запускать `nmap` на localhost, проверять образы на уязвимости с помощью `trivy`, запускать `lynis`.
    *   Парсить вывод и отправлять отчет в Telegram.
    *   Настроить `cron` для еженедельного запуска.
3.  **[ ]** **Центр управления в Telegram (`/telegram-bot`):**
    *   **Важно: Не использовать прямой SSH (`paramiko`).**
    *   Бот должен общаться с системой **только через API**.
    *   **Для метрик:** Бот вызывает эндпоинт `/admin/metrics` (который возвращает JSON с данными о CPU, RAM, используя библиотеку `psutil`).
    *   **Для управления:** Бот отправляет `POST /admin/restart?service=nginx` (эндпоинт, внутри которого вызывается `subprocess.run(["systemctl", "restart", "nginx"])`).
    *   **Для логов:** Бот отправляет `GET /admin/logs?service=backend&lines=50` (эндпоинт, который читает и возвращает последние N строк из log-файла).

---

### **Фаза 5: Дальнейшее Развитие (Future Improvements)**
**Цель:** Масштабирование и углубление инфраструктуры.
**Задачи (по приоритету):**
1.  **[ ]** **Кеширование:** Добавить **Redis** в `docker-compose`. Использовать для хранения JWT blacklist, кеширования частых запросов к БД, хранения сессий.
2.  **[ ]** **Мониторинг (`/metrics`):** Настроить **Prometheus** (сбор метрик с приложения и хоста) и **Grafana** (дашборды для визуализации).
3.  **[ ]** **Оркестрация:** Мигрировать с Docker Compose на **Kubernetes** (k3s) с использованием **Helm**-чартов.
4.  **[ ]** **Infrastructure as Code:** Описать сервера и конфигурацию в **Terraform**.
5.  **[ ]** **Конфигурационный менеджмент:** Управление настройками серверов с помощью **Ansible**.